name: Build WifiTrigger

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [published]

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v3
        
    - name: Install Theos
      run: |
        git clone --recursive https://github.com/theos/theos.git $HOME/theos
        echo "THEOS=$HOME/theos" >> $GITHUB_ENV
        echo "$HOME/theos/bin" >> $GITHUB_PATH
        
    - name: Install iOS SDK
      run: |
        cd $THEOS/sdks
        curl -LO https://github.com/ios-cross/iphonesdk-fake/releases/download/v17.0.0/iPhoneOS15.6.sdk.tar.xz
        tar -xf iPhoneOS15.6.sdk.tar.xz
        
    - name: Install ldid
      run: |
        brew install ldid
        
    - name: Build Package
      run: |
        make clean package FINALPACKAGE=1
      env:
        THEOS: $HOME/theos
        
    - name: Upload Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: WifiTrigger-DEB
        path: packages/
        
    - name: Upload Release Assets
      if: github.event_name == 'release'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./packages/
        asset_name: WifiTrigger.deb
        asset_content_type: application/vnd.debian.binary-package